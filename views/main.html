<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75">
    <title>ChatRemind</title>
    <link rel="stylesheet" href="public/styles.css">
</head>
<body>
    <div class="layout">
        <a href="/"><button id="logo" href="/">ChatRemind</button></a>
        <a href="/mypage"><button id="logout-button">ë§ˆì´í˜ì´ì§€</button></a>
        <a id = "line"></span>
        <a href="/auth/logout"><button id="logout-button">ë¡œê·¸ì•„ì›ƒ</button></a>
    </div>
</body>
<body>
    <div class="chat-container">
        <div id="chat-log">
            <!-- ì±„íŒ… ë‚´ìš©ì´ í‘œì‹œë  ê³³ -->
        </div>
        <input type="text" id="user-input" placeholder="ë©”ì‹œì§€ ì…ë ¥" required autofocus>
        <button id="send-button">ì „ì†¡</button>
        <button id="mic">ğŸ¤</button>
    </div>
    <div class="chat-container">
        <input type="text" id="memo" placeholder="ë¦¬ë§ˆì¸ë”">
        <input type="datetime-local" id="reminder-time" name="reminder-time">
        <button id="save-button">ì €ì¥</button>
    </div>
    <script>
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const memo = document.getElementById('memo');
        const saveButton = document.getElementById('save-button');
        const timeinput = document.getElementById('reminder-time');
        const mySynth = window.speechSynthesis; //js ë‚´ì¥ tts api
        const speech = new webkitSpeechRecognition; //í¬ë¡¬ stt api

        //í˜ì´ì§€ ë¡œë“œ ì‹œì ì˜ ë‚ ì§œ (ë¦¬ë§ˆì¸ë” ìƒì„±ì°½ ê¸°ë³¸ê°’)
        const reloadtime = new Date();
        timeinput.value = reloadtime.getFullYear().toString()+'-'+String(reloadtime.getMonth() + 1).padStart(2, '0')+'-'+String(reloadtime.getDate()).padStart(2, '0')+'T00:00';
        
        //ì±„íŒ… ì—”í„° í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ì „ì†¡
        function sendMessageOnEnter(event) {
            if (event.key === 'Enter') {
                sendButton.click();
            }
        }
        //ë¦¬ë§ˆì¸ë” ì—”í„° í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ì €ì¥
        function saveOnEnter(event) {
            if (event.key === 'Enter') {
                saveButton.click();
            }
        }
        //ì—”í„° í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        userInput.addEventListener('keydown', sendMessageOnEnter); 
        memo.addEventListener('keydown', saveOnEnter);
        
        //ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ìŒì„± ì „ì†¡
        document.getElementById("mic").addEventListener("click", () => {
            speech.start();
        })
        speech.addEventListener("result", (event) => {
            const { transcript } = event["results"][0][0];
            userInput.value = transcript;
            sendButton.click();
        })

        //ì‹œê°„ì´ ëœ ë¦¬ë§ˆì¸ë”ê°€ ìˆëŠ”ì§€ ì²´í¬
        async function getGPTalertresponse(data){
            const reminders = data;
            const currentDate = new Date();
            const year = currentDate.getFullYear().toString().slice(-2);
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const currentTime = new Date();
            const hours = currentTime.getHours().toString().padStart(2, '0');
            const minutes = currentTime.getMinutes().toString().padStart(2, '0');
            const time = hours + minutes;
            const reminderdata = [];
            reminders.forEach(reminder => { //ì €ì¥ëœ ë¦¬ë§ˆì¸ë”ë“¤ ì¤‘ í˜„ì¬ì‹œê°„ê³¼ ì¼ì¹˜í•˜ë©°, ì•Œë¦¼ì´ ë°œìƒí•˜ì§€ ì•Šì•˜ë˜ ë¦¬ë§ˆì¸ë”ë¥¼ í™•ì¸ 
                if (reminder.date == year+month+day && reminder.time == time && reminder.alert != 1){
                    console.log(reminder.alert);
                    reminderdata.push('id:'+reminder.id+',content:'+reminder.content+',date:'+reminder.date+',time:'+reminder.time);
                };
            });
            const reminderdataform = 'day:20'+year+'-'+ month+'-'+ day +',time:'+time+'ë¦¬ë§ˆì¸ë”:'+JSON.stringify(reminderdata);
            //ì•Œë¦¼ì´ í•„ìš”í•œ ë¦¬ë§ˆì¸ë”ê°€ ìˆì„ ê²½ìš° ì•Œë¦¼ì±„íŒ…ì„ ìš”ì²­
            if (reminderdata.length!=0){
                const response = await fetch('/chat/getalertmessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reminderdataform })
                });
                const responsedata = await response.json();
                const utterance = new SpeechSynthesisUtterance(responsedata);
                mySynth.speak(utterance); //tts ì¶œë ¥
                displayAIReply('6'+responsedata);
                wating =0;
                clearInterval(interval);
            }
            else wating = 1;
        }

        //ì•Œë¦¼ì„ ìœ„í•´ ë¦¬ë§ˆì¸ë” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜´, ì•Œë¦¼ ë°œìƒì‹œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´ (ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€)
        let wating = 0;
        let interval;
        setInterval(function() {
                if (wating == 0){
                    wating = 1;
                    fetch('/chat/alert')
                        .then(response => response.json())
                        .then(data => {
                            //5ì´ˆë§ˆë‹¤ ì‹œê°„ì´ ëœ ë¦¬ë§ˆì¸ë”ê°€ ìˆëŠ”ì§€ í™•ì¸
                            interval = setInterval(() => {
                                if (wating == 1){
                                    wating = 2;
                                    if (data.reminders.length!=0) {
                                        getGPTalertresponse(data.reminders);
                                    }
                                }
                            }, 5000);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                };
        }, 5000);

        //ìƒˆë¡œê³ ì¹¨ì‹œ ì±„íŒ… ê¸°ë¡ ì¶œë ¥
        fetch('/chat/getlogs')
            .then(response => response.json())
            .then(data => {
                const chatlogs = data;
                chatlogs.forEach(chatlog => {
                appendMessage(chatlog.role, chatlog.content)
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        //ìƒˆë¡œê³ ì¹¨ì‹œ ë¦¬ë§ˆì¸ë” ì¶œë ¥
        fetch('/reminder/getreminders') 
            .then(response => response.json())
            .then(data => {
                const reminders = data;
                reminders.forEach(reminder => {
                    const reminder_ = document.createElement('div');
                    const remindercontent = document.createElement('div');
                    const memo = document.createElement('a');
                    const daytime = document.createElement('div');
                    const delbutton = document.createElement('button');
                    const modifybutton = document.createElement('button');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    if (reminder.completed == 'ì™„ë£Œ') checkbox.checked = true;                    

                    reminder_.classList.add('chat-container');
                    daytime.classList.add('daytime-container');
                    delbutton.classList.add('del-button');
                    modifybutton.classList.add('del-button');
                    let hour = parseInt(reminder.time.slice(0, 2));
                    let period = 'ì˜¤ì „ ';
                    if (hour >= 12) {
                        period = 'ì˜¤í›„ ';
                        if (hour > 12){
                            hour -= 12;
                        }
                    }
                    if (hour == 0) hour = 12;
                    memo.innerText = 'ã€€'+ reminder.content + '\n';
                    daytime.innerText = 'ã€€ã€€ã€€20' + reminder.date.slice(0, 2) + 'ë…„ ' + reminder.date.slice(2, 4) + 'ì›” ' + reminder.date.slice(4, 6) + 'ì¼, '
                                        + period + hour + ':' + reminder.time.slice(2.4);
                    delbutton.innerText = 'ì‚­ì œ';
                    modifybutton.innerText = 'ìˆ˜ì •';

                    document.body.appendChild(reminder_);
                    remindercontent.appendChild(checkbox);
                    remindercontent.appendChild(memo);
                    reminder_.appendChild(remindercontent);
                    reminder_.appendChild(daytime);
                    remindercontent.appendChild(delbutton);
                    remindercontent.appendChild(modifybutton);
                    
                    //ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
                    checkbox.addEventListener('click', async () => {
                        try {
                            await fetch('/reminder/complete', {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ reminder }),
                            });
                        } catch (error) {
                            console.error(error);
                        }
                    });

                    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
                    delbutton.addEventListener('click', async () => {
                        try {
                            await fetch('/reminder/delete', {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ reminder }),
                            });
                            location.reload();
                        } catch (error) {
                            console.error(error);
                        }
                    });

                    // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    modifybutton.addEventListener('click', async() =>{
                        try{
                            //ê¸°ì¡´ë‚´ìš© ì œê±°
                            remindercontent.remove();
                            daytime.remove();
                            delbutton.remove();
                            modifybutton.remove();

                            //ìˆ˜ì • ì°½ ìƒì„±
                            const modifycontent = document.createElement('input');
                            const modifytime = document.createElement('input');
                            modifytime.type = 'datetime-local';
                            const modifycancel = document.createElement('button');
                            const modifyconfirm = document.createElement('button');

                            modifycontent.classList.add('memo-modify');
                            modifytime.classList.add('reminder-time');
                            modifycancel.classList.add('cancel-button');
                            modifyconfirm.classList.add('confirm-button');

                            modifycontent.value = reminder.content;
                            modifytime.value = '20' + reminder.date.slice(0, 2) + '-' + reminder.date.slice(2, 4) + '-' + reminder.date.slice(4, 6) +
                                                'T' + reminder.time.slice(0, 2) + ':' + reminder.time.slice(2, 4);
                            modifycancel.innerText = 'ì·¨ì†Œ';
                            modifyconfirm.innerText = 'ì €ì¥';

                            reminder_.appendChild(modifycontent);
                            reminder_.appendChild(modifytime);
                            reminder_.appendChild(modifyconfirm);
                            reminder_.appendChild(modifycancel);
                            //ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                            modifycancel.addEventListener('click', async () => {
                                modifycontent.remove();
                                modifytime.remove();
                                modifycancel.remove();
                                modifyconfirm.remove();
                                reminder_.appendChild(remindercontent);
                                reminder_.appendChild(daytime);
                                remindercontent.appendChild(delbutton);
                                remindercontent.appendChild(modifybutton);
                            });
                            // ë‚´ìš© ìˆ˜ì • ì—”í„° ëˆŒë €ì„ ë•Œ
                            function confirmOnEnter(event) {
                                if (event.key === 'Enter') {
                                    modifyconfirm.click();
                                }
                            }
                            //ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                            modifyconfirm.addEventListener('click', async () => {
                                const currentDate = new Date();
                                const year = currentDate.getFullYear().toString().slice(-2);
                                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                                const day = String(currentDate.getDate()).padStart(2, '0');
                                const content = modifycontent.value;
                                const id = reminder.id;
                                const selectedDate = new Date(modifytime.value);
                                let date = selectedDate.getFullYear().toString().slice(2) +
                                            ("0" + (selectedDate.getMonth() + 1)).slice(-2) +
                                            ("0" + selectedDate.getDate()).slice(-2);
                                let time = ("0" + selectedDate.getHours()).slice(-2) + 
                                            ("0" + selectedDate.getMinutes()).slice(-2);
                                await fetch('/reminder/modify', {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ id ,content, date, time }),
                                });
                                location.reload();
                            });        
                            modifycontent.addEventListener('keydown', confirmOnEnter);
                        }catch (error) {
                            console.error(error);
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });

        // ì±„íŒ…ì„ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        function appendMessage(role, content) {
            if (role=='user'){
                const message = document.createElement('div');
                message.classList.add('message', role);
                message.innerText = content;
                chatLog.appendChild(message);
                chatLog.scrollTop = chatLog.scrollHeight;
            }else{
                const message = document.createElement('div');
                const type = document.createElement('div');
                message.classList.add('message', role);
                type.classList.add('type')
                message.innerText = content.slice(1);
                type.innerText =content.charAt(0);
                chatLog.appendChild(message);
                chatLog.appendChild(type);
                chatLog.scrollTop = chatLog.scrollHeight;
            }
        }

        //gpt ëŒ€ë‹µì„ ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜
        function displayAIReply(reply) {
            const aiMessage = document.createElement('div');
            const type = document.createElement('div');
            aiMessage.classList.add('message', 'ai');
            type.classList.add('type')
            aiMessage.innerText = reply.slice(1);
            type.innerText =reply.charAt(0);
            chatLog.appendChild(aiMessage);
            chatLog.appendChild(type);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // ìœ ì €ê°€ ì±„íŒ…ì„ ì…ë ¥í•˜ê³  ì „ì†¡í•  ë•Œì˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        sendButton.addEventListener('click', async () => {
            if(userInput.value != ''){
                const userMessage = userInput.value;
                appendMessage('user', userMessage);
                userInput.value = '';
                // ì„œë²„ë¡œ ì±„íŒ… ë³´ë‚´ê¸°
                const response = await sendMessageToGPT(userMessage);
                const aiReply = response.reply;
                displayAIReply(aiReply); // GPTì˜ ì‘ë‹µì„ ì¶œë ¥
                const utterance = new SpeechSynthesisUtterance(aiReply.slice(1));
                mySynth.speak(utterance); //tts ì¶œë ¥
                // type =2,3,4ì¼ë•Œ ìƒˆë¡œê³ ì¹¨
                if (aiReply.charAt(0) == 2 || aiReply.charAt(0) == 3 || aiReply.charAt(0) == 4 ) location.reload();
            }
        });

        //ì„œë²„ì— ì±„íŒ… ë³´ë‚´ëŠ” í•¨ìˆ˜
        async function sendMessageToGPT(message) {
            const response = await fetch('/chat/send-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message })
            });
            return response.json();
        }

        // ìœ ì €ê°€ ë¦¬ë§ˆì¸ë”ë¥¼ ì…ë ¥í•˜ê³  ì „ì†¡í•  ë•Œì˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        saveButton.addEventListener('click', async () => {
            const currentDate = new Date();
            const year = currentDate.getFullYear().toString().slice(-2);
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const content = memo.value;
            const selectedDate = new Date(timeinput.value);
            let date = selectedDate.getFullYear().toString().slice(2) +
                           ("0" + (selectedDate.getMonth() + 1)).slice(-2) +
                           ("0" + selectedDate.getDate()).slice(-2);
            let time = ("0" + selectedDate.getHours()).slice(-2) + 
                         ("0" + selectedDate.getMinutes()).slice(-2);
            await fetch('/reminder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content, date, time }),
            });
            location.reload();
        });
    </script>
</body>
</html>

